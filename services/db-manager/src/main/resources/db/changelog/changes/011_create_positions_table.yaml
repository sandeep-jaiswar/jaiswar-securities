databaseChangeLog:
  - changeSet:
      id: create_positions_table_011
      author: gemini-idx-assistant
      changes:
        - createTable:
            tableName: positions
            columns:
              - column:
                  name: position_id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: account_id
                  type: UUID
                  constraints:
                    nullable: false
                    foreignKeyName: fk_positions_account_id
                    references: accounts(account_id)
              - column:
                  name: instrument_id
                  type: UUID
                  constraints:
                    nullable: false
                    foreignKeyName: fk_positions_instrument_id
                    references: instruments(instrument_id)
              - column:
                  name: position_date # Date for which this position is reported (snapshot date)
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: quantity # Net quantity of the instrument held
                  type: NUMERIC(19, 4)
                  constraints:
                    nullable: false
              - column:
                  name: average_cost_price # Average price at which the position was acquired
                  type: NUMERIC(19, 9)
              - column:
                  name: market_value # Current market value of the position (quantity * current_market_price)
                  type: NUMERIC(19, 4)
              - column:
                  name: unrealized_pnl # Unrealized profit or loss
                  type: NUMERIC(19, 4)
              - column:
                  name: currency_code # Currency of the position's value
                  type: VARCHAR(3)
                  constraints:
                    nullable: false
              - column:
                  name: last_trade_id_contributing # Optional: ID of the last trade that affected this position
                  type: UUID
                  constraints:
                    foreignKeyName: fk_positions_last_trade_id
                    references: trades(trade_id) # Can be nullable if position is from other sources
              - column:
                  name: created_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP WITH TIME ZONE
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
        # A unique constraint on account, instrument, and date ensures one position entry per instrument per day per account.
        # For real-time positions, the 'position_date' might be a specific timestamp or handled differently.
        # This structure is more geared towards end-of-day or intraday snapshot positions.
        - addUniqueConstraint:
            constraintName: uq_account_instrument_date_position
            tableName: positions
            columnNames: account_id, instrument_id, position_date

        - createIndex:
            indexName: idx_positions_account_instrument
            tableName: positions
            columns:
              - column:
                  name: account_id
              - column:
                  name: instrument_id
        - createIndex:
            indexName: idx_positions_position_date
            tableName: positions
            columns:
              - column:
                  name: position_date
